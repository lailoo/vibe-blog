<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¹¦ç±é˜…è¯» - vibe-blog</title>
    
    <!-- Docsify ä¸»é¢˜ -->
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/docsify@4/lib/themes/vue.css">
    
    <!-- è‡ªå®šä¹‰æ ·å¼ -->
    <style>
        /* ä¹¦ç±å°é¢å¤´éƒ¨ - å±…ä¸­æ˜¾ç¤ºï¼Œæ— èƒŒæ™¯è‰² */
        .book-cover-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 40px 30px;
            margin-bottom: 30px;
            border: 1px solid #e8e8e8;
            border-radius: 12px;
            background: #fff;
        }
        .book-cover-header img {
            width: 120px;
            height: 120px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            object-fit: cover;
            margin-bottom: 20px;
        }
        .book-info {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .book-info h1 {
            margin: 0 0 8px 0;
            font-size: 24px;
            color: #333;
            font-weight: 600;
        }
        .book-info .subtitle {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        .book-info .intro {
            font-size: 13px;
            line-height: 1.6;
            color: #888;
            max-width: 500px;
        }
        .book-meta {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            font-size: 12px;
            color: #999;
        }
        .book-meta span {
            padding: 4px 10px;
            background: #f5f5f5;
            border-radius: 12px;
        }
        
        /* ç« èŠ‚çŠ¶æ€æ ‡è®° */
        .sidebar-nav li a .chapter-status {
            font-size: 11px;
            margin-left: 5px;
        }
        .chapter-status.has-blog {
            color: #4CAF50;
        }
        .chapter-status.no-blog {
            color: #999;
        }
        
        /* éšè—ä¾§è¾¹æ æŠ˜å æ’ä»¶çš„æ–‡ä»¶å›¾æ ‡ */
        .sidebar-nav .app-sub-sidebar li::before,
        .sidebar-nav li > a::before,
        .sidebar-nav li > p::before {
            display: none !important;
        }
        /* ç« èŠ‚æ ‡é¢˜åŠ ç²— */
        .sidebar-nav > ul > li > p {
            font-weight: bold;
        }
        
        /* è¿”å›æŒ‰é’® */
        .back-to-list {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 100;
            padding: 8px 16px;
            background: #fff;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            text-decoration: none;
            color: #333;
            font-size: 13px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .back-to-list:hover {
            background: #f6f8fa;
        }
        
        /* åŠ è½½çŠ¶æ€ */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            color: #666;
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e0e0e0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* å¾…å®Œå–„ç« èŠ‚æ ·å¼ */
        .pending-chapter {
            padding: 40px;
            text-align: center;
            background: #f9f9f9;
            border-radius: 8px;
            margin: 20px 0;
        }
        .pending-chapter .icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        .pending-chapter h3 {
            color: #666;
            margin-bottom: 10px;
        }
        .pending-chapter p {
            color: #999;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <!-- è¿”å›æŒ‰é’® -->
    <a href="/?tab=books" class="back-to-list">â† è¿”å›ä¹¦æ¶</a>
    
    <!-- Docsify æŒ‚è½½ç‚¹ -->
    <div id="app">
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <p>åŠ è½½ä¹¦ç±ä¸­...</p>
        </div>
    </div>
    
    <script>
        // ä» URL è·å–ä¹¦ç± ID
        const urlParams = new URLSearchParams(window.location.search);
        const bookId = urlParams.get('id');
        
        if (!bookId) {
            document.getElementById('app').innerHTML = `
                <div class="loading-container">
                    <p>âŒ ç¼ºå°‘ä¹¦ç± ID å‚æ•°</p>
                    <a href="/?tab=books" style="margin-top: 20px; color: #667eea;">è¿”å›ä¹¦æ¶</a>
                </div>
            `;
        }
        
        // ä¹¦ç±æ•°æ®ç¼“å­˜
        let bookData = null;
        
        // ä¸»é¢˜å›¾æ ‡æ˜ å°„
        const themeIcons = {
            ai: 'ğŸ¤–',
            web: 'ğŸŒ',
            data: 'ğŸ“Š',
            devops: 'âš™ï¸',
            security: 'ğŸ”',
            general: 'ğŸ“–'
        };
        
        // æ ¼å¼åŒ–å­—æ•°
        function formatWordCount(count) {
            if (count >= 10000) {
                return (count / 10000).toFixed(1) + ' ä¸‡å­—';
            }
            return count + ' å­—';
        }
        
        // ç”Ÿæˆä¾§è¾¹æ  Markdown
        function generateSidebarMarkdown(book) {
            let md = `- [ğŸ“– ${book.title}](/)\n`;
            
            if (book.chapters && book.chapters.length > 0) {
                // æŒ‰ç« èŠ‚æ ‡é¢˜åˆ†ç»„ï¼ˆå› ä¸º chapter_index å¯èƒ½ç›¸åŒä½† chapter_title ä¸åŒï¼‰
                const chapterGroups = {};
                for (const chapter of book.chapters) {
                    const title = chapter.chapter_title || 'æœªåˆ†ç±»';
                    if (!chapterGroups[title]) {
                        chapterGroups[title] = {
                            title: title,
                            sections: []
                        };
                    }
                    chapterGroups[title].sections.push(chapter);
                }
                
                // ç”Ÿæˆ Markdown - ç« èŠ‚æ ‡é¢˜åŠ ç²—ï¼Œå°èŠ‚ä½œä¸ºå­é¡¹
                for (const [title, group] of Object.entries(chapterGroups)) {
                    // å¤–å±‚ç« èŠ‚æ ‡é¢˜åŠ ç²—
                    md += `- **${group.title}**\n`;
                    // å°èŠ‚ä½œä¸ºå­é¡¹
                    for (const section of group.sections) {
                        const chapterId = section.id;
                        md += `  - [${section.section_title}](/chapter/${chapterId})\n`;
                    }
                }
            }
            
            return md;
        }
        
        // ç”Ÿæˆå¤§çº² Markdown
        function generateOutlineMarkdown(book) {
            if (!book.chapters || book.chapters.length === 0) {
                return 'æš‚æ— å¤§çº²';
            }
            
            // æŒ‰ç« èŠ‚åˆ†ç»„
            const chapterGroups = {};
            for (const chapter of book.chapters) {
                const idx = chapter.chapter_index;
                if (!chapterGroups[idx]) {
                    chapterGroups[idx] = {
                        title: chapter.chapter_title,
                        sections: []
                    };
                }
                chapterGroups[idx].sections.push(chapter);
            }
            
            let md = '';
            for (const [idx, group] of Object.entries(chapterGroups)) {
                md += `**ç¬¬ ${idx} ç«  ${group.title}**\n\n`;
                
                for (const section of group.sections) {
                    const chapterId = section.id;
                    if (section.blog_id) {
                        md += `- [${section.section_index} ${section.section_title}](/chapter/${chapterId}) ğŸ“„\n`;
                    } else {
                        md += `- ${section.section_index} ${section.section_title} *(å¾…å®Œå–„)*\n`;
                    }
                }
                md += '\n';
            }
            
            return md;
        }
        
        // ç”Ÿæˆä¹¦ç±é¦–é¡µå†…å®¹
        function generateBookHomeContent(book) {
            const themeIcon = themeIcons[book.theme] || 'ğŸ“–';
            const coverImg = book.cover_image || '';
            
            // è§£æé¦–é¡µå†…å®¹
            let homepage = {};
            if (book.homepage_content) {
                try {
                    homepage = typeof book.homepage_content === 'string' 
                        ? JSON.parse(book.homepage_content) 
                        : book.homepage_content;
                } catch (e) {
                    console.warn('è§£æé¦–é¡µå†…å®¹å¤±è´¥:', e);
                }
            }
            
            // è§£æå®Œæ•´å¤§çº²
            let fullOutline = null;
            if (book.full_outline) {
                try {
                    fullOutline = typeof book.full_outline === 'string'
                        ? JSON.parse(book.full_outline)
                        : book.full_outline;
                } catch (e) {
                    console.warn('è§£æå®Œæ•´å¤§çº²å¤±è´¥:', e);
                }
            }
            
            // ç”Ÿæˆäº®ç‚¹åˆ—è¡¨
            let highlightsHtml = '';
            if (homepage.highlights && homepage.highlights.length > 0) {
                highlightsHtml = homepage.highlights.map(h => 
                    `- ${h.icon} **${h.title}**ï¼š${h.description}`
                ).join('\n');
            }
            
            // ç”Ÿæˆç›®æ ‡å—ä¼—
            let audienceHtml = '';
            if (homepage.target_audience && homepage.target_audience.length > 0) {
                audienceHtml = homepage.target_audience.map(a => `- ${a}`).join('\n');
            }
            
            // ç”Ÿæˆå‰ç½®è¦æ±‚
            let prerequisitesHtml = '';
            if (homepage.prerequisites && homepage.prerequisites.length > 0) {
                prerequisitesHtml = homepage.prerequisites.map(p => `- ${p}`).join('\n');
            }
            
            return `
<div class="book-cover-header">
    ${coverImg ? `<img src="${coverImg}" alt="å°é¢">` : `<div style="width:120px;height:120px;background:#f5f5f5;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:48px;margin-bottom:20px;">${themeIcon}</div>`}
    <div class="book-info">
        <h1>${book.title}</h1>
        ${homepage.slogan ? `<p class="subtitle">${homepage.slogan}</p>` : ''}
        <p class="intro">${book.description || 'æš‚æ— ç®€ä»‹'}</p>
        <div class="book-meta">
            <span>ğŸ“– ${book.chapters_count || 0} ç« èŠ‚</span>
            <span>ğŸ“ ${formatWordCount(book.total_word_count || 0)}</span>
            <span>ğŸ”— ${book.blogs_count || 0} ç¯‡åšå®¢</span>
        </div>
    </div>
</div>

${homepage.introduction ? `## ğŸ“– é¡¹ç›®ç®€ä»‹\n\n${homepage.introduction}\n\n` : ''}

${highlightsHtml ? `## âœ¨ é¡¹ç›®äº®ç‚¹\n\n${highlightsHtml}\n\n` : ''}

## ğŸ“‘ å†…å®¹å¤§çº²

${fullOutline ? generateFullOutlineMarkdown(fullOutline) : generateOutlineMarkdown(book)}

${audienceHtml ? `## ğŸ‘¥ ç›®æ ‡å—ä¼—\n\n${audienceHtml}\n\n` : ''}

${prerequisitesHtml ? `## ğŸ“‹ å‰ç½®è¦æ±‚\n\n${prerequisitesHtml}\n\n` : ''}
`;
        }
        
        // ç”Ÿæˆå®Œæ•´å¤§çº² Markdownï¼ˆæ”¯æŒå·²å»ºè®¾/å¾…å»ºè®¾æ ‡è®°ï¼‰
        function generateFullOutlineMarkdown(outline) {
            if (!outline || !outline.chapters || outline.chapters.length === 0) {
                return 'æš‚æ— å¤§çº²';
            }
            
            let md = '';
            for (const chapter of outline.chapters) {
                md += `**ç¬¬ ${chapter.index} ç«  ${chapter.title}**\n\n`;
                
                for (const section of chapter.sections || []) {
                    if (section.type === 'series') {
                        // ç³»åˆ—æ–‡ç« 
                        const statusIcon = section.status === 'built' ? 'âœ…' : (section.status === 'partial' ? 'ğŸ”„' : 'ğŸ“');
                        md += `- ${statusIcon} **${section.title}** (${section.articles?.length || 0} ç¯‡)\n`;
                        
                        for (const article of section.articles || []) {
                            const articleIcon = article.status === 'built' ? 'âœ…' : 'ğŸ“';
                            if (article.status === 'built' && article.chapter_id) {
                                md += `  - ${articleIcon} [${article.order}/${article.total}] [${article.title}](/chapter/${article.chapter_id})\n`;
                            } else {
                                md += `  - ${articleIcon} [${article.order}/${article.total}] ${article.title} *å¾…å»ºè®¾*\n`;
                            }
                        }
                    } else {
                        // å•ä¸ªç« èŠ‚
                        const statusIcon = section.status === 'built' ? 'âœ…' : 'ğŸ“';
                        if (section.status === 'built' && section.chapter_id) {
                            md += `- ${statusIcon} [${section.title}](/chapter/${section.chapter_id})\n`;
                        } else {
                            md += `- ${statusIcon} ${section.title} *å¾…å»ºè®¾*\n`;
                        }
                    }
                }
                md += '\n';
            }
            
            return md;
        }
        
        // Docsify é…ç½®
        window.$docsify = {
            name: 'ä¹¦ç±é˜…è¯»',
            nameLink: '/',
            loadSidebar: true,
            loadNavbar: false,
            subMaxLevel: 3,  // æ˜¾ç¤ºå½“å‰é¡µé¢çš„ h2, h3 æ ‡é¢˜ä½œä¸ºå­ç›®å½•
            maxLevel: 1,     // ä¾§è¾¹æ æ˜¾ç¤ºåˆ° h1 çº§åˆ«
            auto2top: true,
            notFoundPage: false,
            homepage: 'home.md',
            
            // è·¯ç”±åˆ«å - åœ¨ä¾§è¾¹æ è¯·æ±‚ä¸­æ·»åŠ  book_id å‚æ•°
            alias: {
                '/_sidebar.md': `/_sidebar.md?book_id=${bookId}`,
                '/static/_sidebar.md': `/_sidebar.md?book_id=${bookId}`,
                '/.*/_sidebar.md': `/_sidebar.md?book_id=${bookId}`
            },
            
            // æ’ä»¶
            plugins: [
                // åŠ¨æ€å†…å®¹åŠ è½½æ’ä»¶
                function(hook, vm) {
                    // åˆå§‹åŒ–æ—¶é¢„åŠ è½½ä¹¦ç±æ•°æ®
                    hook.init(function() {
                        if (bookId && !bookData) {
                            fetch(`/api/books/${bookId}`)
                                .then(res => res.json())
                                .then(result => {
                                    if (result.success) {
                                        bookData = result.book;
                                        document.title = bookData.title + ' - vibe-blog';
                                    }
                                })
                                .catch(e => console.error('é¢„åŠ è½½ä¹¦ç±å¤±è´¥:', e));
                        }
                    });
                    
                    hook.beforeEach(function(content, next) {
                        // è·å–å½“å‰è·¯ç”±
                        const route = vm.route.path;
                        console.log('Docsify route:', route);
                        
                        // ä¾§è¾¹æ è¯·æ±‚
                        if (route === '/_sidebar.md' || route === '_sidebar.md' || route.endsWith('_sidebar.md')) {
                            if (bookData) {
                                next(generateSidebarMarkdown(bookData));
                            } else {
                                fetch(`/api/books/${bookId}`)
                                    .then(res => res.json())
                                    .then(result => {
                                        if (result.success) {
                                            bookData = result.book;
                                            next(generateSidebarMarkdown(bookData));
                                        } else {
                                            next('- [é¦–é¡µ](/)');
                                        }
                                    })
                                    .catch(() => next('- [é¦–é¡µ](/)'));
                            }
                            return;
                        }
                        
                        // é¦–é¡µæˆ–ç©ºè·¯ç”±
                        if (route === '/' || route === '' || route === '/home.md' || route === '/home') {
                            // åŠ è½½ä¹¦ç±æ•°æ®
                            if (!bookData) {
                                fetch(`/api/books/${bookId}`)
                                    .then(res => res.json())
                                    .then(result => {
                                        if (result.success) {
                                            bookData = result.book;
                                            document.title = bookData.title + ' - vibe-blog';
                                            next(generateBookHomeContent(bookData));
                                        } else {
                                            next('# åŠ è½½å¤±è´¥\n\n' + (result.error || 'æ— æ³•è·å–ä¹¦ç±ä¿¡æ¯'));
                                        }
                                    })
                                    .catch(e => {
                                        next('# åŠ è½½å¤±è´¥\n\n' + e.message);
                                    });
                            } else {
                                next(generateBookHomeContent(bookData));
                            }
                            return;
                        }
                        
                        // ç« èŠ‚è·¯ç”± - æ”¯æŒ /chapter/xxx å’Œ /chapter/xxx.md æ ¼å¼
                        if (route.startsWith('/chapter/') || route.startsWith('chapter/')) {
                            let chapterId = route.replace(/^\/?chapter\//, '').replace(/\.md$/, '');
                            fetch(`/api/books/${bookId}/chapters/${chapterId}`)
                                .then(res => res.json())
                                .then(result => {
                                    if (!result.success) {
                                        next('# åŠ è½½å¤±è´¥\n\n' + (result.error || 'æ— æ³•è·å–ç« èŠ‚å†…å®¹'));
                                        return;
                                    }
                                    if (result.has_content && result.markdown_content) {
                                        // è½¬æ¢å›¾ç‰‡è·¯å¾„ï¼š./images/xxx -> /outputs/images/xxx
                                        let content = result.markdown_content;
                                        // Markdown å›¾ç‰‡è¯­æ³•: ![alt](./images/xxx)
                                        content = content.replace(/\(\.\/images\//g, '(/outputs/images/');
                                        // Markdown å›¾ç‰‡è¯­æ³•: ![alt](images/xxx)
                                        content = content.replace(/\(images\//g, '(/outputs/images/');
                                        // HTML img æ ‡ç­¾
                                        content = content.replace(/src="\.\/images\//g, 'src="/outputs/images/');
                                        content = content.replace(/src='\.\/images\//g, "src='/outputs/images/");
                                        // æ‰“å°æ‰€æœ‰å›¾ç‰‡è·¯å¾„
                                        const imgMatches = content.match(/!\[([^\]]*)\]\(([^)]+)\)/g);
                                        console.log('å›¾ç‰‡è·¯å¾„:', imgMatches);
                                        console.log('è½¬æ¢åçš„å†…å®¹ç‰‡æ®µ:', content.substring(0, 500));
                                        next(content);
                                    } else {
                                        const title = result.section_title || result.chapter_title || 'æœªå‘½åç« èŠ‚';
                                        next(`# ${title}\n\n<div class="pending-chapter"><div class="icon">ğŸ“</div><h3>è¯¥ç« èŠ‚å†…å®¹å¾…å®Œå–„</h3><p>æ•¬è¯·æœŸå¾…...</p></div>`);
                                    }
                                })
                                .catch(e => {
                                    next('# åŠ è½½å¤±è´¥\n\n' + e.message);
                                });
                            return;
                        }
                        
                        // å…¶ä»–è·¯ç”±ï¼Œè¿”å›åŸå†…å®¹
                        next(content);
                    });
                    
                    hook.doneEach(function() {
                        // æ‹¦æˆªç« èŠ‚é“¾æ¥ç‚¹å‡»ï¼Œæ‰‹åŠ¨å¤„ç†è·¯ç”±
                        document.querySelectorAll('a[href^="/chapter/"]').forEach((link) => {
                            link.onclick = function(e) {
                                e.preventDefault();
                                e.stopPropagation();
                                window.location.hash = '#' + this.getAttribute('href');
                                return false;
                            };
                        });
                        
                        // ä»£ç é«˜äº®
                        document.querySelectorAll('pre code').forEach((block) => {
                            if (window.hljs) {
                                hljs.highlightElement(block);
                            }
                        });
                        
                        // Mermaid å›¾è¡¨æ¸²æŸ“
                        if (window.mermaid) {
                            // æŸ¥æ‰¾æ‰€æœ‰ mermaid ä»£ç å—å¹¶æ¸²æŸ“
                            document.querySelectorAll('pre code.language-mermaid, pre code.lang-mermaid').forEach((block) => {
                                const pre = block.parentElement;
                                const div = document.createElement('div');
                                div.className = 'mermaid';
                                // é¢„å¤„ç† Mermaid ä»£ç ï¼Œä¿®å¤ç©ºæ ‡ç­¾é—®é¢˜
                                let code = block.textContent;
                                code = code.replace(/(\bsubgraph\s+\w+)\[""\]/g, '$1[" "]');
                                code = code.replace(/(\w+)\[""\]/g, '$1[" "]');
                                div.textContent = code;
                                pre.parentNode.replaceChild(div, pre);
                            });
                            
                            // é‡æ–°æ¸²æŸ“æ‰€æœ‰ mermaid å›¾è¡¨
                            mermaid.run({ nodes: document.querySelectorAll('.mermaid') });
                        }
                    });
                }
            ]
        };
    </script>
    
    <!-- Docsify æ ¸å¿ƒ -->
    <script src="//cdn.jsdelivr.net/npm/docsify@4/lib/docsify.min.js"></script>
    
    <!-- æœç´¢æ’ä»¶ -->
    <script src="//cdn.jsdelivr.net/npm/docsify@4/lib/plugins/search.min.js"></script>
    
    <!-- ä»£ç é«˜äº® -->
    <script src="//cdn.jsdelivr.net/npm/prismjs@1/components/prism-python.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/prismjs@1/components/prism-javascript.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/prismjs@1/components/prism-bash.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/prismjs@1/components/prism-json.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/prismjs@1/components/prism-sql.min.js"></script>
    
    <!-- Mermaid å›¾è¡¨ -->
    <script src="//cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
        // åˆå§‹åŒ– Mermaid
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            securityLevel: 'loose'
        });
    </script>
    
    <!-- ä¾§è¾¹æ æŠ˜å æ’ä»¶ -->
    <script src="//cdn.jsdelivr.net/npm/docsify-sidebar-collapse/dist/docsify-sidebar-collapse.min.js"></script>
</body>
</html>
